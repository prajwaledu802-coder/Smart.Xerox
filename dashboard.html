<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Smart Xerox</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2"
                style="font-size: 1.5rem; font-weight: 700; color: var(--dark);">
                <span style="color: var(--primary);">âš¡</span> SmartXerox
            </a>
            <div class="nav-toggle" style="font-size: 1.5rem;">â˜°</div>
            <div class="nav-links flex gap-4" id="nav-auth"></div>
        </div>
    </nav>

    <main class="container mt-8 animate-fade">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 style="font-weight: 800;">Welcome back!</h1>
                <p class="text-muted">Here is what's happening with your prints.</p>
            </div>
            <button class="btn btn-outline btn-sm hover-scale" onclick="Auth.logout()">Logout âžœ</button>
        </div>

        <div class="stats-grid animate-slide" style="animation-delay: 0.1s;">
            <div class="stat-card">
                <div class="stat-icon bg-yellow-light">ðŸ“„</div>
                <div>
                    <h3 id="stat-total">0</h3>
                    <p class="text-sm text-muted">Total Orders</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bg-blue-light">ðŸ’¸</div>
                <div>
                    <h3 id="stat-spent">â‚¹0</h3>
                    <p class="text-sm text-muted">Total Spent</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bg-green-light">ðŸŒ³</div>
                <div>
                    <h3 id="stat-saved">0</h3>
                    <p class="text-sm text-muted">High Fives</p>
                </div>
            </div>
        </div>

        <div class="mt-8 animate-slide" style="animation-delay: 0.2s;">
            <div class="flex justify-between items-center mb-4">
                <h3>Recent Activity</h3>
                <button class="btn btn-sm btn-outline" onclick="Dashboard.loadOrders()">Refresh â†»</button>
            </div>

            <div style="overflow-x: auto; padding-bottom: 2rem;">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Details</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Invoice</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-orders">
                        <tr>
                            <td colspan="5" class="text-center p-4">Loading your data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="toast-container"></div>

    <script src="js/app.js"></script>
    <script src="js/invoice.js"></script>
    <script>
        const Dashboard = {
            async init() {
                if (!Store.user) {
                    window.location.href = 'login.html';
                    return;
                }
                await this.loadOrders();
            },

            async loadOrders() {
                const tbody = document.getElementById('dashboard-orders');
                const orders = await API.fetchOrders(Store.user.id);

                document.getElementById('stat-total').innerText = orders.length;
                const totalSpent = orders.reduce((acc, o) => acc + o.total, 0);
                document.getElementById('stat-spent').innerText = 'â‚¹' + totalSpent;
                document.getElementById('stat-saved').innerText = orders.length > 0 ? 'High 5!' : '0';

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No orders found. Start one today!</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map((o, index) => {
                    const statusClass = `badge-${o.status.toLowerCase()}`;
                    return `
                        <tr style="animation: slideUp 0.3s ease forwards; animation-delay: ${index * 0.1}s; opacity: 0;">
                            <td>
                                <span style="font-weight: 700; color: var(--secondary);">#${o.order_id.split('-')[0]}</span><br>
                                <span class="text-sm text-muted">${new Date(o.date).toLocaleDateString()}</span>
                            </td>
                            <td>
                                <div style="font-weight: 500;">${o.print_type || 'Print Job'}</div>
                                <div class="text-sm text-muted">${o.files}</div>
                            </td>
                            <td style="font-weight: 600;">â‚¹${o.total}</td>
                            <td><span class="status-badge ${statusClass}">${o.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick='InvoiceSystem.generate(${JSON.stringify(o)})'>
                                    â¬‡ PDF
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        };

        window.addEventListener('load', () => {
            if (window.App) App.init();
            Dashboard.init();
        });
    </script>
</body>

</html>